!function(e,t){"use strict";t.module("RPGPlatinumApp",["ngRoute","ngAnimate","ngCookies","LocalStorageModule","ngMaterial","ngFileUpload"]).config(["$mdThemingProvider","$mdIconProvider","$routeProvider","$locationProvider",function(e,t,a,n){e.theme("default").primaryPalette("blue").accentPalette("orange").warnPalette("red"),t.defaultIconSet("asset/img/default-set.svg",24),a.when("/list/:query?",{templateUrl:"datalist.html"}).when("/rpg/new",{templateUrl:"newdata.html"}).when("/rpg/:oid",{templateUrl:"datacontent.html"}).when("/user/:username",{templateUrl:"userdata.html"}).otherwise({redirectTo:"/list"}),n.html5Mode(!1).hashPrefix("!")}]),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,a=Object(this),n=a.length>>>0,r=arguments[1],o=0;o<n;o++)if(t=a[o],e.call(r,t,o,a))return t}),e.ObjectSize=function(e){var t,a=0;for(t in e)e.hasOwnProperty(t)&&a++;return a}}(window,angular),function(e,t){"use strict";t.module("RPGPlatinumApp").controller("RPGPlatinum",["$rootScope","$scope","$location","$http","$mdPanel","$log","Upload","$mdToast","$sce","$routeParams","$cookies","localStorageService","$mdDialog",function(e,a,n,r,o,s,i,l,g,p,u,c,d){e.$on("$locationChangeStart",function(e){t.element(document).find("md-dialog").length>0&&(e.preventDefault(),d.cancel())}),e.$on("$routeChangeStart",function(e,t){switch(t.templateUrl){case"newdata.html":a.user.info.islogin?v.getLocalData():n.url("list");break;case"datalist.html":t.params.query&&(a.rpg.listsQuery=t.params.query.replace("+"," ")),v.getListData();break;case"datacontent.html":v.getRpgData(t.params.oid);break;case"userdata.html":v.getUserData(t.params.username)}}),a.title="RPG Platinum",a.page={now:"datalist.html",last:null,config:t.fromJson(document.querySelector("#page-config").value),loadingCircular:0};var m,f={name:"",level:0,type:"root",sub:[]},h={breif:{title:"",description:"",coverFile:null},chapters:t.copy(f),tempChapterName:""};a.rpg={lists:[],listsPager:null,listsQuery:"",listsLoadMore:function(){v.getListData()},detail:{},newRpgData:t.copy(h),loading:!1},a.progress={save:function(){r.post("actions/ajax.php",{action:"save",progress:a.rpg.detail.progress,oid:a.rpg.detail.oid})},delaySave:function(){a.user.info.islogin?(clearTimeout(m),m=setTimeout(function(){a.progress.save()},1e4)):c.set("progress",a.rpg.detail.progress)},load:function(){r.post("actions/ajax.php",{action:"load",oid:a.rpg.detail.oid}).then(function(e){var t=e.data;t.success?a.rpg.detail.progress=t.data.progress:v.toast(t.msg)},function(e){var t=e.data;t.msg?v.toast(t.msg):v.toast("server error.")})}},a.changepage=function(e,t){switch(a.page.last=a.page.now,a.page.now=e,e){case"newdata.html":a.user.info.islogin?n.url("rpg/new"):n.url("list");break;case"datalist.html":t?n.url("list/"+t.replace(" ","+")):n.url("list");break;case"datacontent.html":n.url("rpg/"+t);break;case"userdata.html":n.url("user/"+t)}},a.goIndex=function(e){e.stopPropagation(),a.rpg.listsQuery="",a.changepage("datalist.html")},a.search=function(e){13===e.keyCode&&a.rpg.listsQuery&&a.changepage("datalist.html",a.rpg.listsQuery)},a.gotop=function(){var e=document.querySelector(".main-container"),t=setInterval(function(){e.scrollTop-=Math.ceil(.1*(e.scrollTop+e.scrollTop)),0==e.scrollTop&&clearInterval(t)},10)},a.clearNewRpgData=function(){a.rpg.newRpgData=t.copy(h)},a.user={info:{username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""},userMenu:function(e,t){t.stopPropagation(),e.open(t)},login:function(e,o){if(e=e||!1)var i={action:"logincheck"};else var i={action:"login",username:a.user.info.username,password:a.user.info.password};a.user.info.logining=!0,a.user.info.msg="",r.post("actions/ajax.php",i).then(function(r){var i=r.data;i.success?(a.user.info.uid=i.data.uid,a.user.info.username=i.data.username,a.user.info.islogin=!0,v.toast("登录成功。"),!e&&/^\/rpg\/\d+$/i.test(n.path())&&(s.log("Load progress."),a.progress.load()),t.isFunction(o)&&o()):a.user.info.msg=i.msg,a.user.info.password="",a.user.info.logining=!1},function(e){var t=e.data;t.msg?v.toast(t.msg):v.toast("server error."),a.user.info.islogin=!1})},logout:function(e){e.stopPropagation(),s.log("Logout."),u.remove(a.page.config.cookieSuffix+"token"),a.user.info={username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""}},loginFrame:function(e){e.stopPropagation();var n=o.newPanelPosition().relativeTo(e.toElement).addPanelPosition(o.xPosition.ALIGN_END,o.yPosition.BELOW),r=o.newPanelAnimation().openFrom(e.toElement).withAnimation(o.animation.SCALE),s={animation:r,attachTo:t.element(document.body),controller:["mdPanelRef",function(e){this.parent=a,this.close=function(){a.user.info.logining=!1,a.user.info.msg="",e.close()}}],controllerAs:"LoginPanelCtrl",template:'<div md-whiteframe="4" class="login-panel-frame">  <md-input-container class="md-block hide-error-msg">    <label>用户名</label>    <input ng-model="LoginPanelCtrl.parent.user.info.username" type="text">  </md-input-container>  <md-input-container class="md-block hide-error-msg">    <label>密码</label>    <input ng-model="LoginPanelCtrl.parent.user.info.password" type="password">  </md-input-container>  <div class="login-error-message" ng-show="LoginPanelCtrl.parent.user.info.msg">    <span md-colors="{color: \'warn\'}"           ng-bind="LoginPanelCtrl.parent.user.info.msg"></span>  </div>  <div layout="row">    <md-button ng-click="LoginPanelCtrl.close()"                ng-disabled="LoginPanelCtrl.parent.user.info.logining">取消</md-button>    <md-button class="md-raised md-primary"               ng-click="LoginPanelCtrl.parent.user.login(false, LoginPanelCtrl.close)"               ng-disabled="LoginPanelCtrl.parent.user.info.logining">    登入    </md-button>  </div></div>',panelClass:"login-panel",position:n,zIndex:2,clickOutsideToClose:!1,escapeToClose:!0,focusOnOpen:!1,hasBackdrop:!1,disableParentScroll:!0};o.open(s)},registerPanel:function(e){d.show({controller:["$mdDialog",function(e){this.parent=a,this.registerInfo={username:"",password:"",password2:""},this.close=function(){a.user.info.logining=!1,a.user.info.msg="",e.hide()},this.register=function(){if(!/^[A-Za-z_][A-Za-z0-9_]+$/.test(this.registerInfo.username))return a.user.info.msg="用户名只允许使用字母、数字、下划线且不以数字开头。",!1;if(""===this.registerInfo.password||this.registerInfo.password!==this.registerInfo.password2)return a.user.info.msg="两次密码不一样。",!1;var t={action:"register",username:this.registerInfo.username,password:this.registerInfo.password};a.user.info.logining=!0,r.post("actions/ajax.php",t).then(function(n){var r=n.data;r.success?(a.user.info.username=t.username,a.user.info.password=t.password,a.user.login(),e.hide()):a.user.info.msg=r.msg,a.user.info.logining=!1},function(e){var t=e.data;t.msg?v.toast(t.msg):v.toast("server error."),a.user.info.logining=!1})}}],controllerAs:"registerPanel",templateUrl:"registerPanel.html",parent:t.element(document.querySelector(".main-container")),targetEvent:e,clickOutsideToClose:!1,fullscreen:!0})},deleteRpg:function(e){confirm("此列表有 "+e.progress_count+" 个进度，删除后无法恢复，确定要删除 "+e.title+" 吗？")&&r.post("actions/ajax.php",{action:"deleterpg",oid:e.oid}).then(function(t){var n=t.data;if(n.success){var r=a.userdetail.created.indexOf(e);a.userdetail.created.splice(r,1)}else v.toast(n.msg)},function(e){a.page.loadingCircular-=1;var t=e.data;t.msg?v.toast(t.msg):v.toast("server error.")})}},a.newrpg={addchapter:function(){""!==a.rpg.newRpgData.chapters[a.rpg.newRpgData.chapters.length-1].name&&a.rpg.newRpgData.chapters.push(t.copy(f))},addsub:function(e){try{if(e.level<3){var n=t.copy(f);n.level=e.level+1,e.type="cat",e.sub.push(n),c.set("newRpgData",a.rpg.newRpgData)}}catch(e){s.log(e.message)}},removesub:function(e,t){if("item"===e.type)e.sub=[];else{var a=e.sub.indexOf(t);e.sub.splice(a,1)}e.sub.length||(e.type="root")},checksub:function(e,t){""===t.name&&this.removesub(e,t)},additem:function(e){e.type="item"},submitrpg:function(){var e={url:"actions/ajax.php",method:"POST",data:{action:"newrpg",rpgdata:{breif:{title:a.rpg.newRpgData.breif.title,description:a.rpg.newRpgData.breif.description},chapters:a.rpg.newRpgData.chapters},cover:a.rpg.newRpgData.breif.coverFile}};a.rpg.loading=!0,i.upload(e).then(function(e){var t=e.data;t.success?(c.remove("newRpgData"),a.changepage("datalist.html")):v.toast(t.msg),a.rpg.loading=!1},function(e){var t=e.data;t.msg?v.toast(t.msg):v.toast("server error."),a.rpg.loading=!1})}};var v={getRpgData:function(e){a.page.loadingCircular+=1,r.post("actions/ajax.php",{action:"rpgdetail",oid:e}).then(function(e){a.page.loadingCircular-=1;var t=e.data;a.rpg.detail=t.data[0],v.getLocalProgress()})},getListData:function(){a.rpg.listsPager=null,a.page.loadingCircular+=1;var e={action:"rpglist"};a.rpg.listsPager&&a.rpg.listsPager.page&&(e.page=a.rpg.listsPager.page+1),a.rpg.listsQuery&&(e.query=a.rpg.listsQuery),r.post("actions/ajax.php",e).then(function(e){a.page.loadingCircular-=1;var n=e.data;a.rpg.listsPager=n.data.pager,1!==a.rpg.listsPager.page?t.forEach(n.data.orderList,function(e){a.rpg.lists.push(e)}):a.rpg.lists=n.data.orderList},function(e){a.page.loadingCircular-=1;var t=e.data;t.msg?v.toast(t.msg):v.toast("server error.")})},getLocalData:function(){c.get("newRpgData")&&(a.rpg.newRpgData=c.get("newRpgData"),v.toast("发现未提交的数据并已加载。"))},getLocalProgress:function(){a.user.islogin&&c.get("progress")&&(a.rpg.detail.progress=c.get("progress"))},getUserData:function(e){a.page.loadingCircular+=1,a.userdetail=null,r.post("actions/ajax.php",{action:"userdetail",username:e}).then(function(e){a.page.loadingCircular-=1;var t=e.data;t.success?a.userdetail=t.data:v.toast(t.msg)},function(e){a.page.loadingCircular-=1;var t=e.data;t.msg?v.toast(t.msg):v.toast("server error.")})},init:function(){a.user.login(!0),a.pageloaded=!0},toast:function(e,t){t=t||"3000",l.show(l.simple().textContent(g.trustAsHtml(e)).position("bottom left").hideDelay(t))}};v.init()}])}(window,angular);