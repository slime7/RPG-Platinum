!function(t,e){"use strict";e.module("RPGPlatinumApp",["ngRoute","ngAnimate","ngCookies","LocalStorageModule","ngMaterial","ngFileUpload"]).config(["$mdThemingProvider","$mdIconProvider","$routeProvider","$locationProvider",function(t,e,a,n){t.theme("default").primaryPalette("blue").accentPalette("orange").warnPalette("red"),e.defaultIconSet("asset/material-icons/default-set.svg",24),a.when("/list",{templateUrl:"datalist.html"}).when("/rpg/new",{templateUrl:"newdata.html"}).when("/rpg/:oid",{templateUrl:"datacontent.html"}).otherwise({redirectTo:"/list"}),n.html5Mode(!1).hashPrefix("!")}]),Array.prototype.find||(Array.prototype.find=function(t){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,a=Object(this),n=a.length>>>0,o=arguments[1],i=0;i<n;i++)if(e=a[i],t.call(o,e,i,a))return e}),t.ObjectSize=function(t){var e,a=0;for(e in t)t.hasOwnProperty(e)&&a++;return a}}(window,angular),function(t,e){"use strict";e.module("RPGPlatinumApp").controller("RPGPlatinum",["$scope","$location","$http","$mdPanel","$log","Upload","$mdToast","$sce","$routeParams","$cookies","localStorageService",function(t,a,n,o,i,r,s,l,g,p,c){t.title="RPG Platinum",t.page={now:"datalist.html",last:null,config:e.fromJson(document.querySelector("#page-config").value),loadingCircular:!1};var u,d={name:"",level:0,type:"root",sub:[]},m={breif:{title:"",description:"",coverFile:null},chapters:e.copy(d),tempChapterName:""};t.rpg={lists:[],listsPager:null,listsLoadMore:function(){f.getListData()},detail:{},newRpgData:e.copy(m),loading:!1},t.progress={save:function(){n.post("actions/ajax.php",{action:"save",progress:t.rpg.detail.progress,oid:t.rpg.detail.oid})},delaySave:function(){t.user.info.islogin&&(clearTimeout(u),u=setTimeout(function(){t.progress.save()},1e4))},load:function(){n.post("actions/ajax.php",{action:"load",oid:t.rpg.detail.oid}).then(function(e){var a=e.data;a.success?t.rpg.detail.progress=a.data.progress:f.toast(a.msg)},function(t){var e=t.data;e.msg?f.toast(e.msg):f.toast("server error.")})}},t.changepage=function(e,n){switch(t.page.last=t.page.now,t.page.now=e,e){case"newdata.html":a.url("rpg/new"),c.get("newRpgData")&&f.getLocalData();break;case"datalist.html":t.rpg.listsPager=null,a.url("list"),f.getListData();break;case"datacontent.html":a.url("rpg/"+n),f.getRpgData(n)}},t.goIndex=function(e){e.stopPropagation(),t.changepage("datalist.html")},t.gotop=function(){var t=document.querySelector(".main-container"),e=setInterval(function(){t.scrollTop-=Math.ceil(.1*(t.scrollTop+t.scrollTop)),0==t.scrollTop&&clearInterval(e)},10)},t.clearNewRpgData=function(){t.rpg.newRpgData=e.copy(m)},t.user={info:{username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""},login:function(o,r){if(o=o||!1)var s={action:"logincheck"};else var s={action:"login",username:t.user.info.username,password:t.user.info.password};t.user.info.logining=!0,t.user.info.msg="",n.post("actions/ajax.php",s).then(function(n){var s=n.data;s.success?(t.user.info.uid=s.data.uid,t.user.info.username=s.data.username,t.user.info.islogin=!0,f.toast("登录成功。"),!o&&/^\/rpg\/\d+$/i.test(a.path())&&(i.log("Load progress."),t.progress.load()),e.isFunction(r)&&r()):t.user.info.msg=s.msg,t.user.info.password="",t.user.info.logining=!1},function(e){var a=e.data;a.msg?f.toast(a.msg):f.toast("server error."),t.user.info.islogin=!1})},logout:function(e){e.stopPropagation(),i.log("Logout."),p.remove(t.page.config.cookieSuffix+"token"),t.user.info={username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""}},loginFrame:function(a){a.stopPropagation();var n=o.newPanelPosition().relativeTo(a.toElement).addPanelPosition(o.xPosition.ALIGN_END,o.yPosition.BELOW),i=o.newPanelAnimation().openFrom(a.toElement).withAnimation(o.animation.SCALE),r={animation:i,attachTo:e.element(document.body),controller:["mdPanelRef",function(e){this.parent=t,this.close=function(){e.close()}}],controllerAs:"LoginPanelCtrl",template:'<div md-whiteframe="4" class="login-panel-frame">  <md-input-container class="md-block hide-error-msg">    <label>用户名</label>    <input ng-model="LoginPanelCtrl.parent.user.info.username" type="text">  </md-input-container>  <md-input-container class="md-block hide-error-msg">    <label>密码</label>    <input ng-model="LoginPanelCtrl.parent.user.info.password" type="password">  </md-input-container>  <div class="login-error-message" ng-show="LoginPanelCtrl.parent.user.info.msg">    <span md-colors="{color: \'warn\'}"           ng-bind="LoginPanelCtrl.parent.user.info.msg"></span>  </div>  <div layout="row">    <md-button ng-click="LoginPanelCtrl.close()"                ng-disabled="LoginPanelCtrl.parent.user.info.logining">取消</md-button>    <md-button class="md-raised md-primary"               ng-click="LoginPanelCtrl.parent.user.login(false, LoginPanelCtrl.close)"               ng-disabled="LoginPanelCtrl.parent.user.info.logining">    登入    </md-button>  </div></div>',panelClass:"login-panel",position:n,zIndex:2,clickOutsideToClose:!1,escapeToClose:!0,focusOnOpen:!1,hasBackdrop:!1,disableParentScroll:!0};o.open(r)}},t.newrpg={addchapter:function(){""!==t.rpg.newRpgData.chapters[t.rpg.newRpgData.chapters.length-1].name&&t.rpg.newRpgData.chapters.push(e.copy(d))},addsub:function(a){try{if(a.level<3){var n=e.copy(d);n.level=a.level+1,a.type="cat",a.sub.push(n),c.set("newRpgData",t.rpg.newRpgData)}}catch(t){i.log(t.message)}},removesub:function(t,e){if("item"===t.type)t.sub=[];else{var a=t.sub.indexOf(e);t.sub.splice(a,1)}t.sub.length||(t.type="root")},checksub:function(t,e){""===e.name&&this.removesub(t,e)},additem:function(t){t.type="item"},submitrpg:function(){var e={url:"actions/ajax.php",method:"POST",data:{action:"newrpg",rpgdata:{breif:{title:t.rpg.newRpgData.breif.title,description:t.rpg.newRpgData.breif.description},chapters:t.rpg.newRpgData.chapters},cover:t.rpg.newRpgData.breif.coverFile}};t.rpg.loading=!0,r.upload(e).then(function(e){var a=e.data;a.success?(c.remove("newRpgData"),t.changepage("datalist.html")):f.toast(a.msg),t.rpg.loading=!1},function(e){var a=e.data;a.msg?f.toast(a.msg):f.toast("server error."),t.rpg.loading=!1})}};var f={getRpgData:function(e){t.page.loadingCircular=!0,n.post("actions/ajax.php",{action:"rpgdetail",oid:e}).then(function(e){t.page.loadingCircular=!1;var a=e.data;t.rpg.detail=a.data[0]})},getListData:function(){t.page.loadingCircular=!0;var a={action:"rpglist"};t.rpg.listsPager&&1!==t.rpg.listsPager.page&&(a.page=t.rpg.listsPager.page+1),n.post("actions/ajax.php",a).then(function(a){t.page.loadingCircular=!1;var n=a.data;t.rpg.listsPager=n.data.pager,1!==t.rpg.listsPager.page?e.extend(t.rpg.lists,n.data.orderList):t.rpg.lists=n.data.orderList})},getLocalData:function(){t.rpg.newRpgData=c.get("newRpgData"),f.toast("发现未提交的数据并已加载。")},init:function(){t.user.login(!0),(/^\/list$/i.test(a.path())||""==a.path())&&f.getListData(),/^\/rpg\/\d+$/i.test(a.path())&&f.getRpgData(a.path().substr(5)),/^\/rpg\/new$/i.test(a.path())&&f.getLocalData()},toast:function(t,e){e=e||"3000",s.show(s.simple().textContent(l.trustAsHtml(t)).position("bottom left").hideDelay(e))}};f.init()}])}(window,angular);