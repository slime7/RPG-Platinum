!function(e,t){"use strict";t.module("RPGPlatinumApp",["ngRoute","ngAnimate","ngCookies","LocalStorageModule","ngMaterial","ngFileUpload"]).config(["$mdThemingProvider","$mdIconProvider","$routeProvider","$locationProvider",function(e,t,n,o){e.theme("default").primaryPalette("blue").accentPalette("orange").warnPalette("red"),t.defaultIconSet("asset/material-icons/default-set.svg",24),n.when("/list",{templateUrl:"datalist.html"}).when("/rpg/new",{templateUrl:"newdata.html"}).when("/rpg/:oid",{templateUrl:"datacontent.html"}).otherwise({redirectTo:"/list"}),o.html5Mode(!1).hashPrefix("!")}]),Array.prototype.find||(Array.prototype.find=function(e){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),o=n.length>>>0,a=arguments[1],i=0;i<o;i++)if(t=n[i],e.call(a,t,i,n))return t}),e.ObjectSize=function(e){var t,n=0;for(t in e)e.hasOwnProperty(t)&&n++;return n}}(window,angular),function(e,t){"use strict";t.module("RPGPlatinumApp").controller("RPGPlatinum",["$scope","$location","$http","$mdPanel","$log","Upload","$mdToast","$sce","$routeParams","$cookies",function(e,n,o,a,i,r,s,l,p,c){e.title="RPG Platinum",e.page={now:"datalist.html",last:null,config:t.fromJson(document.querySelector("#page-config").value)};var g,u={name:"",level:0,type:"root",sub:[]};e.rpg={lists:[],detail:{},newRpgData:{breif:{title:"",description:"",coverFile:null},chapters:t.copy(u),tempChapterName:""},loading:!1},e.progress={save:function(){o.post("actions/ajax.php",{action:"save",progress:e.rpg.detail.progress,oid:e.rpg.detail.oid})},delaySave:function(){e.user.info.islogin&&(clearTimeout(g),g=setTimeout(function(){e.progress.save()},1e4))},load:function(){o.post("actions/ajax.php",{action:"load",oid:e.rpg.detail.oid}).then(function(t){var n=t.data;n.success?e.rpg.detail.progress=n.data.progress:d.toast(n.msg)},function(e){d.toast("server error.")})}},e.changepage=function(t,o){switch(e.page.last=e.page.now,e.page.now=t,t){case"newdata.html":n.url("rpg/new");break;case"datalist.html":n.url("list"),d.getListData();break;case"datacontent.html":n.url("rpg/"+o),d.getRpgData(o)}},e.user={info:{username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""},login:function(a,r){if(a=a||!1)var s={action:"logincheck"};else var s={action:"login",username:e.user.info.username,password:e.user.info.password};e.user.info.logining=!0,e.user.info.msg="",o.post("actions/ajax.php",s).then(function(o){var s=o.data;s.success?(e.user.info.uid=s.data.uid,e.user.info.username=s.data.username,e.user.info.islogin=!0,d.toast("登录成功。"),!a&&/^\/rpg\/\d+$/i.test(n.path())&&(i.log("Load progress."),e.progress.load()),t.isFunction(r)&&r()):e.user.info.msg=s.msg,e.user.info.password="",e.user.info.logining=!1},function(t){e.user.info.msg="server error.",e.user.info.islogin=!1})},logout:function(){i.log("Logout."),c.remove(e.page.config.cookieSuffix+"token"),e.user.info={username:"",password:"",uid:null,islogin:!1,logining:!1,msg:""}},loginFrame:function(n){var o=a.newPanelPosition().relativeTo(n.toElement).addPanelPosition(a.xPosition.ALIGN_END,a.yPosition.BELOW),i=a.newPanelAnimation().openFrom(n.toElement).withAnimation(a.animation.SCALE),r={animation:i,attachTo:t.element(document.body),controller:["mdPanelRef",function(t){this.parent=e,this.close=function(){t.close()}}],controllerAs:"LoginPanelCtrl",template:'<div md-whiteframe="4" class="login-panel-frame">  <md-input-container class="md-block hide-error-msg">    <label>Username</label>    <input ng-model="LoginPanelCtrl.parent.user.info.username" type="text">  </md-input-container>  <md-input-container class="md-block hide-error-msg">    <label>Password</label>    <input ng-model="LoginPanelCtrl.parent.user.info.password" type="password">  </md-input-container>  <div class="login-error-message" ng-show="LoginPanelCtrl.parent.user.info.msg">    <span md-colors="{color: \'warn\'}"           ng-bind="LoginPanelCtrl.parent.user.info.msg"></span>  </div>  <div layout="row">    <md-button ng-click="LoginPanelCtrl.close()"                ng-disabled="LoginPanelCtrl.parent.user.info.logining">cancel</md-button>    <md-button class="md-raised md-primary"               ng-click="LoginPanelCtrl.parent.user.login(false, LoginPanelCtrl.close)"               ng-disabled="LoginPanelCtrl.parent.user.info.logining">    login    </md-button>  </div></div>',panelClass:"login-panel",position:o,zIndex:2,clickOutsideToClose:!1,escapeToClose:!0,focusOnOpen:!1,hasBackdrop:!0,disableParentScroll:!0};a.open(r)}},e.newrpg={addchapter:function(){""!==e.rpg.newRpgData.chapters[e.rpg.newRpgData.chapters.length-1].name&&e.rpg.newRpgData.chapters.push(t.copy(u))},addsub:function(e){try{if(e.level<3){var n=t.copy(u);n.level=e.level+1,e.type="cat",e.sub.push(n)}}catch(t){console.log(t.message),console.log(e)}},removesub:function(e,t){if("item"===e.type)e.sub=[];else{var n=e.sub.indexOf(t);e.sub.splice(n,1)}e.sub.length||(e.type="root")},checksub:function(e,t){""===t.name&&this.removesub(e,t)},additem:function(e){e.type="item"},submitrpg:function(){var t={url:"actions/ajax.php",method:"POST",data:{action:"newrpg",rpgdata:{breif:{title:e.rpg.newRpgData.breif.title,description:e.rpg.newRpgData.breif.description},chapters:e.rpg.newRpgData.chapters},cover:e.rpg.newRpgData.breif.coverFile}};e.rpg.loading=!0,r.upload(t).then(function(t){var o=t.data;o.success?n.url("list"):d.toast(o.msg),e.rpg.loading=!1},function(t){d.toast("server error."),e.rpg.loading=!1})}};var d={getRpgData:function(t){o.post("actions/ajax.php",{action:"rpgdetail",oid:t}).then(function(t){var n=t.data;e.rpg.detail=n.data[0]})},getListData:function(){o.post("actions/ajax.php",{action:"rpglist"}).then(function(t){var n=t.data;e.rpg.lists=n.data.orderList})},init:function(){e.user.login(!0),(/^\/list$/i.test(n.path())||""==n.path())&&d.getListData(),/^\/rpg\/\d+$/i.test(n.path())&&d.getRpgData(n.path().substr(5))},toast:function(e,t){t=t||"3000",s.show(s.simple().textContent(l.trustAsHtml(e)).position("bottom left").hideDelay(t))}};d.init()}])}(window,angular);